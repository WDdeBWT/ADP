{% extends 'ctf_base.html' %}


{% block title %}CTF详情 - 攻防演练平台{% endblock %}


{% block custom_bread %}
    <section>
        <div class="wp">
            <div class="crumbs">
                <ul>
                    <li><a href="{% url 'index' %}">首页</a>></li>
                    <li><a href="{% url 'ctf:ctf_list' %}">CTF题库</a>></li>
                    <li>CTF详情</li>
                </ul>
            </div>
        </div>
    </section>
{% endblock %}


{% block custom_css %}
    <link href="/static/css/common_2016.css" media="screen" rel="stylesheet" type="text/css">
    <link href="/static/css/ctf/CTF_Details.css" media="screen" rel="stylesheet" type="text/css">
{% endblock %}


{% block content %}
    <div class="container">
        <div class="details_main">

            <!--内容左-->
            <div class="details_main_left">
                <div class="de_mle_title">
                    <h3>{{ ctf.name }}<span>分值：{{ ctf.score }}</span></h3>
                </div>
                <!--参数-->
                <div class="de_mle_par">
                    <ul>
                        <li>题目来源：<span>{{ ctf.source }}</span></li>
                        <li>题目难度：<span>{{ ctf.get_degree_display }}</span></li>
                        <li>点击人数：<span>{{ ctf.click_num }}人</span></li>
                        <li>答题次数：<span>{{ ctf.submit_num }}人</span></li>
                        <li>夺旗人数：<span>{{ ctf.success_num }}人</span></li>
                        <li>解题通过率：<span>{{ pass_rate }}%</span></li>
                    </ul>
                </div>
                <!--清除浮动-->
                <div style="clear: both"></div>
                <!--内容居中-->
                <div class="de_mle_con">
                    <!--解题链接-->
                    <div class="de_mle_link">
                        <div class="de_mle_p1">{{ ctf.detail }}</div>
                        <p class="de_mle_p2">解题链接：
                            <a href="{{ ctf.url }}" id="exam_ctf_href" target="_blank">{{ ctf.url }}</a>
                        </p>
                    </div>

                    <div class="de_mle_text">
                        <input class="de_mle_t" type="text" name="" id="key_txt" value="">
                        <div class="verification">
                            <button id="keysubmit_btn" class="de_mle_btn key_btn" type="submit">提 交</button>
                        </div>

                    </div>


                    <div class="de_mle_comment">
                        <label>评论</label>
                    <textarea name="" rows="" cols="" placeholder="切勿在评论、文章中发表不适当的言论以及各类题目的答案"
                              id="comment_content"></textarea>
                    </div>
                    <div style="clear: both"></div>
                    <div class="de_mle_com">
                        <button class="de_mle_com_btn" type="submit" id="comment_btn">提交评论</button>
                    </div>

                    <!--提示弹出层-->
                    <div class="pop_markW" style="display: none;">
                        <div class="pop_mark"></div>
                    </div>

                    <!--回答正确时 提示-->
                    <div class="popideawrap rightwrap clearfix" id="pop_key_ok" style="display: none;">
                        <div class="CloseBtn">关闭弹出</div>
                        <div class="ideawrap">
                            <div class="icon rightimg"></div>
                            <div class="txt">
                                <p class="bigred">回答正确</p>
                                <p>厉害了,我的哥！！！</p>
                            </div>
                            <a class="cancel r" href="javascript:;">继续加油</a>
                        </div>
                    </div>

                    <!-- 回答错误时-->
                    <div class="popideawrap wrongwrap clearfix" id="pop_key_no" style="display: none;">
                        <div class="CloseBtn">关闭弹出</div>
                        <div class="ideawrap">
                            <div class="icon wrongimg"></div>
                            <div class="txt">
                                <p class="bigred">回答错误!</p>
                                <div><p>加油(๑•̀ㅂ•́)و✧加油</p></div>
                            </div>
                            <a class="cancel r" href="javascript:;">再来一次</a>
                        </div>
                    </div>

                    <!--评论列表-->
                    <!--评论-->
                    <div class="de_mle_topic_main" id="comment_list_ul">
                        {% for comment in comments.object_list %}
                            <div class="de_mle_topic_title">
                                <div class="de_mle_topic">
                                    <!--头像-->
                                    <a>
                                        <div class="de_mle_topic_head">
                                            <img src="{{ MEDIA_URL }}{{ comment.user.image }}">
                                            <div class="topic_title">{{ comment.user.nick_name }}</div>
                                        </div>
                                    </a>
                                    <!--文本内容-->
                                    <div class="topic_text">
                                        <p>{{ comment.comments }}</p>
                                    </div>
                                    <div class="topic_text_time">
                                        <span>{{ comment.add_time }}</span>
                                    </div>
                                </div>
                                <div style="clear: both"></div>
                                <!--回复标题-->
                                <div class="de_mle_reply">

                                </div>
                            </div>
                            <div style="clear: both"></div>
                        {% endfor %}
                    </div>
                    <!-- 分页 -->
                    <div class="CTF_paging">
                        <div class="pagerbar">
                            {% if comments.has_previous %}
                                <a class="first"
                                   href="?{{ comments.previous_page_number.querystring }}">上一页</a>
                            {% endif %}

                            {% for page in comments.pages %}
                                {% if page %}
                                    {% ifequal page comments.number %}
                                        <a class="current" href="?{{ page.querystring }}">{{ page }}</a>
                                    {% else %}
                                        <a href="?{{ page.querystring }}" class="">{{ page }}</a>
                                    {% endifequal %}
                                {% else %}
                                    <a href="">...</a>
                                {% endif %}
                            {% endfor %}

                            {% if comments.has_next %}
                                <a class="last" href="?{{ comments.next_page_number.querystring }}">下一页</a>
                            {% endif %}
                        </div>
                    </div>
                    <!-- 分页end -->
                </div>
            </div>

            <!--内容右-->
            <div class="details_main_right">

                <!--右边最新题目的内容-->
                <div class="details_main_right_newest">
                    <h3>最新题目<a>NEW</a></h3>
                    <ul>
                        {% for new_ctf in new_ctfs %}
                            <li><span></span><a href="{% url 'ctf:ctf_detail' new_ctf.id %}"
                                                target="_blank">{{ new_ctf.name }}</a></li>
                        {% endfor %}
                    </ul>
                </div>

            </div>
        </div>

    </div>

{% endblock %}

{% block custom_js %}
    <script type="text/javascript" src="/static/js/lib/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="/static/js/common.js"></script>
    <script type="text/javascript" src="/static/js/plug/jquery.validate.js"></script>
    <script type="text/javascript" src="/static/js/plug/messages_zh.js"></script>
    <script type="text/javascript" src="/static/js/plug/jquery.form.js"></script>
    <script type="text/javascript" src="/static/js/layer/layer.js"></script>
    <script type="text/javascript" src="/static/js/layer/laytpl.js"></script>
    <script type="text/javascript">
        //提交答案
        $("#keysubmit_btn").click(function () {
            var flag = '{{ flag }}';
            if (flag == 1) {
                var key = $.trim($("#key_txt").val());
                if (key == "") {
                    layer.alert("提交答案不能为空");
                    return false;
                }
                var ExamCTFID = '{{ ctf.id }}';
                $.ajax({
                    dataType: 'JSON',
                    cache: false,
                    async: true,
                    type: 'POST',
                    url: "{% url 'ctf:ctf_answer' %}",
                    data: {key: key, ExamCTFID: ExamCTFID},
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                    },
                    success: function (res) {
                        if (res.code == '001') {
                            layer.alert("该题已答过");
                        } else if (res.code == '002') {
                            layer.alert("提交答案失败");
                        } else if (res.code == '003') {
                            if (res.Score > 0) {
                                $("#ok_icon").show();
                                $("#keysubmit_btn").attr('disabled', "true");
                                $("#key_txt").attr("readonly", "readonly");
                                $(".pop_markW,#pop_key_ok").fadeIn(200);
                            } else {
                                $(".pop_markW,#pop_key_no").fadeIn(200);
                                $("#pop_key_no .txt").children('div').html('兄弟你,回答错啦!');
                            }
                        }
                    }
                });

            } else {
                window.location.href = "{% url 'register' %}"; //弹出登录
            }
        });
        $(".ideawrap .sure,.ideawrap .cancel,.popideawrap .CloseBtn").click(function () {
            $(".pop_markW,.popideawrap").fadeOut(200);
        });


        //提交评论
        $('#comment_btn').bind('click', function () {
            var flag = '{{ flag }}';
            if (flag == 1) {
                SubmitComment();
            } else {
                window.location.href = "{% url 'register' %}"; //弹出登录
            }
        });

        function SubmitComment() {
            var ctfid = '{{ ctf.id }}';
            var content = $("#comment_content").val();
            if ($.trim(content) == '') {
                layer.alert('请输入内容');
            } else {
                $.ajax({
                    dataType: 'JSON',
                    type: 'POST',
                    url: '{% url 'ctf:ctf_comment' %}',
                    data: {ExamCTFID: ctfid, Content: content},
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                    },
                    success: function (data) {
                        layer.alert(data.msg);
                        //显示服务器端传过来的数据,然后一秒后刷新页面
                        setTimeout("window.location.reload();", 800)
                    }
                });
            }
        }
    </script>
{% endblock %}
